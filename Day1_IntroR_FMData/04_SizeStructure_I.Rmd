---
title: "Size Structure I"
author: "Derek H. Ogle, Northland College"
date: "2-Mar-2015"
output: pdf_document
geometry: margin=0.6in
---

```{r echo=FALSE, results='hide'}
fn <- "04_SizeStructure_I.Rmd"
library(knitr)
source("../knitr_setup.R")
```

#Preliminaries
```{r results='hide', warning=FALSE, message=FALSE}
library(fishWiDNR)   # for setDBClasses()
library(dplyr)       # for filter(), select(), mutate(), group_by(), summarize()
library(FSA)         # for Summarize(), hist(), expandCounts()
library(lubridate)   # for month()
```

```{r, cache=TRUE, message=FALSE}
setwd("C:/aaaWork/Web/fishR/Courses/WiDNR_Statewide_2015/Day1_IntroR_FMData")
d <- read.csv("FMDB_Sawyer_MultiYr_APEX.csv",stringsAsFactors=FALSE,na.strings=c("-","NA",""))
d <- setDBClasses(d,type="RDNR")
d <- expandCounts(d,~Number.of.Fish,~Length.or.Lower.Length.IN+Length.Upper.IN,new.name="Len")
d <- mutate(d,Mon=month(Survey.Begin.Date,label=TRUE))
d <- select(d,Species,Waterbody.Name,Survey.Year,Gear,Survey.Begin.Date,Mon,Len)
```

```{r, cache=TRUE, message=FALSE}
Spr <- filter(d,Survey.Year==2013,Mon %in% c("Apr","May","Jun"))
Spr <- droplevels(Spr)
BGSpr <- filter(Spr,Species=="BLUEGILL")
BGSpr <- droplevels(BGSpr)
BGSprLC <- filter(BGSpr,Waterbody.Name=="LAKE CHETAC",Gear=="BOOM SHOCKER")
BGSprLC <- droplevels(BGSprLC)
```
So ...

* `Spr` has all species sampled from all water bodies in the Spring of 2013.
* `BGSpr` has only Bluegill sampled from all water bodies in the Spring of 2013.
* `BGSprLC` has only Bluegill sampled with boom schokers from Lake Chetac in the Spring of 2013.

... and they all look roughly like this ...

```{r echo=FALSE}
head(BGSprLC)
```

\vspace{18pt}

#Very Simple Summaries

```{r}
Summarize(~Len,data=BGSprLC,digits=2)
```

\newpage

#Length Frequency Histograms

```{r hist_basic}
hist(~Len,data=BGSprLC)
```

```{r hist_options}
hist(~Len,data=BGSprLC,xlab="Total Length (In.)",ylab="Number of Bluegill",
     xlim=c(3,9),ylim=c(0,80),col="salmon")
```

\newpage

```{r hist_breaks}
hist(~Len,data=BGSprLC,xlab="Total Length (In.)",ylab="Number of Bluegill",
     xlim=c(3,9),ylim=c(0,40),breaks=seq(3,9,0.2))
```

#Multiple Summaries at Once

```{r}
BGSpr <- group_by(BGSpr,Waterbody.Name)
summarize(BGSpr,n=n(),meanLen=mean(Len))                    # see use of na.rm=TRUE below
```

\newpage

```{r}
summarize(BGSpr,n=n(),valid_n=sum(!is.na(Len)),
           meanLen=mean(Len,na.rm=TRUE),sdLen=sd(Len,na.rm=TRUE),
           minLen=min(Len,na.rm=TRUE),maxLen=max(Len,na.rm=TRUE)  )
```

```{r}
BGSpr <- filter(BGSpr,Len>=3)
summarize(BGSpr,n=n(),valid_n=sum(!is.na(Len)),
           meanLen=round(mean(Len,na.rm=TRUE),2),sdLen=round(sd(Len,na.rm=TRUE),2),
           minLen=min(Len,na.rm=TRUE),maxLen=max(Len,na.rm=TRUE),
           PSDQ=perc(Len,6,digits=0),PSD7=perc(Len,7,digits=0),PSDP=perc(Len,8,digits=0)  )
```

```{r}
Spr <- group_by(Spr,Waterbody.Name,Species)
summarize(Spr,n=n(),valid_n=sum(!is.na(Len)),
           meanLen=round(mean(Len,na.rm=TRUE),2),sdLen=round(sd(Len,na.rm=TRUE),2)  )
```

\newpage

# Application Assignment

Create a script that performs the following tasks:

1. Load and prepare your FM data in R (**HINT:** *use all or some of your scripts from previous application assignments*).
1. Reduce your data.frame to one year and several (4 or more) fish of interest.  Call this the *original data.frame.*
1. Reduce the *original data.frame* to one water body and species of interest.
    * Compute summary stastistics for the length variable.
    * Construct a length frequency histogram.
    * Does your description of the length frequency change dramatically with different bin widths?
1. Reduce the *original data.frame* to only one species.
    * Efficiently construct summary statistics for the length variable for each water body.  Include PSD values that are of interest to you  (**HINT**: *use, for example,* `psdVal("Largemouth Bass",units="in")` *to find Gabelhouse lengths for a particular species*).

1. (*Time Permitting*) Re-create the summary statistics for one species in each water body but include calculations of the median and first and third quartiles (**HINT**: *use, for example,* `quantile(x,0.50,na.rm=TRUE)` *to compute the median (i.e., 50% quantile) of the data in* `x`.).
1. (*Time Permitting*) Compute summary statistics of the length variable for each water body AND each of the several species of interest to you.  Save the summary statistics to an object and write the results to a CSV file.

**Save your script!**
